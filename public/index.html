<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Protocol Execution â€” API Tester</title>
    <style>
      /* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family:
          "Segoe UI",
          system-ui,
          -apple-system,
          sans-serif;
        background: #0f1117;
        color: #e1e4ea;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 2rem 1rem;
      }

      .container {
        max-width: 720px;
        width: 100%;
      }

      /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      header {
        text-align: center;
        margin-bottom: 2rem;
      }

      header h1 {
        font-size: 1.6rem;
        font-weight: 700;
        background: linear-gradient(135deg, #6ee7b7, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.5px;
      }

      header p {
        color: #6b7280;
        font-size: 0.85rem;
        margin-top: 0.35rem;
      }

      /* â”€â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .card {
        background: #1a1d27;
        border: 1px solid #2a2d3a;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.25rem;
      }

      .card h2 {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #9ca3af;
        margin-bottom: 1rem;
      }

      /* â”€â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .form-group {
        margin-bottom: 1rem;
      }

      /* Endpoint Hero Section */
      .endpoint-hero {
        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        text-align: center;
        border: 1px solid #4a5568;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .endpoint-hero .method {
        background-color: #48bb78;
        color: #fff;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-weight: bold;
        font-size: 1.25rem;
        vertical-align: middle;
        margin-right: 0.75rem;
      }

      .endpoint-hero .url {
        color: #e2e8f0;
        font-family: "Fira Code", monospace;
        font-size: 1.5rem;
        font-weight: 600;
        vertical-align: middle;
      }

      .endpoint-hero .description {
        margin-top: 0.75rem;
        color: #a0aec0;
        font-size: 0.95rem;
      }

      .grid {
        display: grid;
      }

      label {
        display: block;
        font-size: 0.8rem;
        font-weight: 500;
        color: #9ca3af;
        margin-bottom: 0.3rem;
      }

      input {
        width: 100%;
        padding: 0.6rem 0.75rem;
        background: #0f1117;
        border: 1px solid #2a2d3a;
        border-radius: 8px;
        color: #e1e4ea;
        font-size: 0.9rem;
        transition: border-color 0.2s;
      }

      input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
      }

      button {
        width: 100%;
        padding: 0.7rem;
        background: linear-gradient(135deg, #3b82f6, #6366f1);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition:
          opacity 0.2s,
          transform 0.1s;
      }

      button:hover {
        opacity: 0.9;
      }
      button:active {
        transform: scale(0.98);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* â”€â”€â”€ Output Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .output {
        background: #0f1117;
        border: 1px solid #2a2d3a;
        border-radius: 8px;
        padding: 1rem;
        min-height: 80px;
        font-family: "Cascadia Code", "Fira Code", monospace;
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-break: break-word;
        overflow-y: auto;
        max-height: 300px;
      }

      .output.empty {
        color: #4b5563;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* â”€â”€â”€ Status Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .status {
        display: inline-block;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        margin-left: 0.5rem;
      }

      .status.ok {
        background: #065f46;
        color: #6ee7b7;
      }
      .status.err {
        background: #7f1d1d;
        color: #fca5a5;
      }
      .status.wait {
        background: #78350f;
        color: #fde68a;
      }

      /* â”€â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card {
        animation: fadeIn 0.4s ease-out;
      }
      .card:nth-child(2) {
        animation-delay: 0.1s;
      }
      .card:nth-child(3) {
        animation-delay: 0.2s;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Hero Section for API Endpoint -->
      <div class="endpoint-hero">
        <span class="method">POST</span>
        <span class="url">/api/v1/protocol-executions</span>
        <div class="description">
          Initiate a simulation of a protocol execution
        </div>
      </div>

      <header>
        <h1>âš¡ Protocol Execution Tester</h1>
      </header>

      <!-- â”€â”€â”€ Request Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="card">
        <h2>ðŸ”‘ Request</h2>
        <div class="form-group">
          <label for="apiKey">API Key (X-API-Key)</label>
          <input type="text" id="apiKey" value="rh_test_alpha_92f4c1" />
        </div>
        <div class="form-group">
          <label for="protocolId">Protocol ID</label>
          <input type="text" id="protocolId" value="safety-check-v1" />
        </div>
        <div class="form-group">
          <label for="siteId">Site ID</label>
          <input type="text" id="siteId" value="site-001" />
        </div>
        <div class="form-group">
          <label for="webhookUrl">Webhook URL</label>
          <input
            type="text"
            id="webhookUrl"
            value="http://localhost:4001/webhook-receiver"
          />
        </div>
        <button id="submitBtn" onclick="executeProtocol()">
          Execute Protocol
        </button>
      </div>

      <!-- â”€â”€â”€ API Response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="card">
        <h2>ðŸ“¡ API Response <span id="statusBadge"></span></h2>
        <div id="apiResponse" class="output empty">Waiting for requestâ€¦</div>
      </div>

      <!-- â”€â”€â”€ Webhook Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="card">
        <h2>ðŸ”” Webhook Events <span id="webhookCount"></span></h2>
        <div id="webhookEvents" class="output empty">
          No events received yetâ€¦
        </div>
      </div>
    </div>

    <script>
      const API_URL = "/api/v1/protocol-executions";
      let polling = false;

      async function executeProtocol() {
        const btn = document.getElementById("submitBtn");
        const responseEl = document.getElementById("apiResponse");
        const badgeEl = document.getElementById("statusBadge");

        btn.disabled = true;
        btn.textContent = "Sendingâ€¦";
        responseEl.classList.remove("empty");
        responseEl.textContent = "Sending requestâ€¦";
        badgeEl.innerHTML = '<span class="status wait">PENDING</span>';

        const body = {
          protocolId: document.getElementById("protocolId").value,
          siteId: document.getElementById("siteId").value,
          webhookUrl: document.getElementById("webhookUrl").value,
        };

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-API-Key": document.getElementById("apiKey").value,
            },
            body: JSON.stringify(body),
          });

          const data = await res.json();

          responseEl.textContent = JSON.stringify(data, null, 2);

          if (res.ok) {
            badgeEl.innerHTML =
              '<span class="status ok">' + res.status + " CREATED</span>";
            // Start polling for webhook events
            startPolling();
          } else {
            badgeEl.innerHTML =
              '<span class="status err">' + res.status + " ERROR</span>";
          }
        } catch (err) {
          responseEl.textContent = "Network error: " + err.message;
          badgeEl.innerHTML = '<span class="status err">FAILED</span>';
        } finally {
          btn.disabled = false;
          btn.textContent = "Execute Protocol";
        }
      }

      function startPolling() {
        if (polling) return;
        polling = true;

        const interval = setInterval(async () => {
          try {
            const res = await fetch("/webhook-events");
            const events = await res.json();

            if (events.length > 0) {
              const el = document.getElementById("webhookEvents");
              const countEl = document.getElementById("webhookCount");
              el.classList.remove("empty");
              el.textContent = JSON.stringify(events, null, 2);
              countEl.innerHTML =
                '<span class="status ok">' + events.length + "</span>";
            }
          } catch {
            /* ignore polling errors */
          }
        }, 1500);

        // Stop polling after 15 seconds
        setTimeout(() => {
          clearInterval(interval);
          polling = false;
        }, 15000);
      }
    </script>
  </body>
</html>
